<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{.Config.Title}}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .item-photo {
      object-fit: cover;
      border-radius: 4px;
    }
    .photo-preview {
      display: none;
      margin-top: 10px;
    }
    .thumb-container {
      position: relative;
      display: inline-block;
    }
    .hover-preview {
      display: none;
      position: fixed;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .hover-preview img {
      max-width: 60vw;
      max-height: 60vh;
      object-fit: contain;
    }
    .thumb-container:hover .hover-preview {
      display: block;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>{{.Config.Title}}</h1>
      <div class="d-flex align-items-center">
        <span class="me-3">Welcome, {{.Username}} ({{.Role}})</span>
        {{if eq .Role "admin"}}
        <a href="/estantes" class="btn btn-secondary me-2">Manage Shelves</a>
        <a href="/usuarios" class="btn btn-secondary me-2">Manage Users</a>
        {{end}}
        <a href="/logout" class="btn btn-outline-danger">Logout</a>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <form method="get" class="row g-3">
          <div class="col-md-4">
            <input type="text" class="form-control" name="q" placeholder="Search items..." value="{{.Query}}">
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Search</button>
          </div>
          {{if eq .Role "admin"}}
          <div class="col-md-2">
            <a href="/novo" class="btn btn-success w-100">Add New Item</a>
          </div>
          {{end}}
        </form>
      </div>
    </div>

    <table class="table table-striped">
      <thead class="table-dark">
        <tr>
          <th> </th>
          <th>Item</th>
          <th>Description</th>
          <th>Shelf</th>
          <th>Rack</th>
          <th>Compartment</th>
          {{if eq .Role "admin"}}
          <th>Actions</th>
          {{end}}
        </tr>
      </thead>
      <tbody>
        {{if .Itens}}
          {{range .Itens}}
          <tr>
            <td>
              {{if .Foto}}
                <div class="thumb-container">
                  <a href="/static/photos/{{.Foto}}" target="_blank">
                    <img src="/static/photos/thumbs/{{.Foto}}" class="item-photo" alt="{{.Nome}}" style="width: {{$.Config.PhotoThumbSize}}px; height: {{$.Config.PhotoThumbSize}}px;">
                  </a>
                  <div class="hover-preview">
                    <img src="/static/photos/{{.Foto}}" alt="{{.Nome}}">
                  </div>
                </div>
              {{else}}
                <div class="item-photo bg-secondary" style="width: {{$.Config.PhotoThumbSize}}px; height: {{$.Config.PhotoThumbSize}}px;"></div>
              {{end}}
            </td>
            <td>{{.Nome}}</td>
            <td>{{.Descricao}}</td>
            <td>{{.Estante}}</td>
            <td>{{.Prateleira}}</td>
            <td>{{.Compartimento}}</td>
            {{if eq $.Role "admin"}}
            <td>
              <button class="btn btn-sm btn-primary" onclick="editItem({{.ID}}, '{{js .Nome}}', '{{js .Descricao}}', '{{js .Estante}}', '{{js .Prateleira}}', '{{js .Compartimento}}')">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteItem({{.ID}})">Delete</button>
            </td>
            {{end}}
          </tr>
          {{end}}
        {{else}}
          <tr>
            <td colspan="7" class="text-center">No items found</td>
          </tr>
        {{end}}
      </tbody>
    </table>

    {{if gt .Pagination.TotalPages 1}}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        <li class="page-item {{if eq .Pagination.CurrentPage 1}}disabled{{end}}">
          <a class="page-link" href="?page={{subtract .Pagination.CurrentPage 1}}{{if .Query}}&q={{.Query}}{{end}}">Previous</a>
        </li>
        {{range seq 1 .Pagination.TotalPages}}
        <li class="page-item {{if eq . $.Pagination.CurrentPage}}active{{end}}">
          <a class="page-link" href="?page={{.}}{{if $.Query}}&q={{$.Query}}{{end}}">{{.}}</a>
        </li>
        {{end}}
        <li class="page-item {{if eq .Pagination.CurrentPage .Pagination.TotalPages}}disabled{{end}}">
          <a class="page-link" href="?page={{add .Pagination.CurrentPage 1}}{{if .Query}}&q={{.Query}}{{end}}">Next</a>
        </li>
      </ul>
    </nav>
    {{end}}
  </div>

  {{if eq .Role "admin"}}
  <script>
    function editItem(id, nome, descricao, estante, prateleira, compartimento) {
      window.location.href = `/editar?id=${id}&nome=${encodeURIComponent(nome)}&descricao=${encodeURIComponent(descricao)}&estante=${encodeURIComponent(estante)}&prateleira=${encodeURIComponent(prateleira)}&compartimento=${encodeURIComponent(compartimento)}`;
    }

    function deleteItem(id) {
      if (confirm('Are you sure you want to delete this item?')) {
        window.location.href = `/deletar?id=${id}`;
      }
    }
  </script>
  {{end}}
</body>
</html>
