<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{.Config.Title}}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .item-photo {
      cursor: pointer;
      transition: transform 0.2s ease;
      border: 2px solid #dee2e6;
    }
    .item-photo:hover {
      transform: scale(1.05);
      border-color: #0d6efd;
    }
    .photo-preview {
      position: fixed;
      z-index: 1000;
      pointer-events: none;
      max-width: {{.Config.PhotoPreviewSize}}px;
      max-height: {{.Config.PhotoPreviewSize}}px;
      object-fit: contain;
      display: none;
      border: 1px solid #ccc;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    .thumb-container {
      position: relative;
      display: inline-block;
    }
    .card {
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
    }
    .no-photo-placeholder {
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    }
    .no-photo-placeholder:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25);
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>{{.Config.Title}}</h1>
      <div class="d-flex align-items-center">
        <span class="me-3">Welcome, {{.Username}} ({{.Role}})</span>
        {{if eq .Role "admin"}}
        <a href="/estantes" class="btn btn-secondary me-2">Manage Shelves</a>
        <a href="/racks" class="btn btn-secondary me-2">Manage Racks</a>
        <a href="/usuarios" class="btn btn-secondary me-2">Manage Users</a>
        {{end}}
        <a href="/logout" class="btn btn-outline-danger">Logout</a>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <form method="get" class="row g-3">
          <div class="col-md-4">
            <input type="text" class="form-control" name="q" placeholder="Search items..." value="{{.Query}}">
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Search</button>
          </div>
          {{if eq .Role "admin"}}
          <div class="col-md-2">
            <a href="/novo" class="btn btn-success w-100">Add New Item</a>
          </div>
          {{end}}
        </form>
      </div>
    </div>

    <!-- Items Grid -->
    <div class="row g-3">
      {{if .Itens}}
        {{range .Itens}}
        <div class="col-lg-4 col-md-6 col-sm-12">
          <div class="card h-100 shadow-sm">
            <div class="card-body p-3">
              <!-- Photo Section -->
              <div class="text-center mb-3">
                {{if and .Foto (ne .Foto "")}}
                  <div class="thumb-container">
                    <img src="/static/photos/thumbs/{{.Foto}}" class="item-photo rounded" alt="{{.Nome}}" style="width: 150px; height: 150px; object-fit: cover;">
                  </div>
                {{else}}
                  <div class="no-photo-placeholder d-flex flex-column align-items-center justify-content-center rounded" style="width: 150px; height: 150px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid #e9ecef;">
                    <svg width="48" height="48" fill="currentColor" class="bi bi-image mb-2" viewBox="0 0 16 16">
                      <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                      <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
                    </svg>
                    <small class="text-white-50">No Image</small>
                  </div>
                {{end}}
              </div>
              
              <!-- Item Info -->
              <h6 class="card-title fw-bold text-primary mb-2">{{.Nome}}</h6>
              <p class="card-text text-muted mb-3" style="min-height: 2.4em;">{{.Descricao}}</p>
              
              <!-- Location Info -->
              <div class="row text-center mb-3">
                <div class="col-4">
                  <small class="text-muted d-block">Rack</small>
                  <span class="badge bg-secondary">{{.Prateleira}}</span>
                </div>
                <div class="col-4">
                  <small class="text-muted d-block">Shelf</small>
                  <span class="badge bg-info">{{.Estante}}</span>
                </div>
                <div class="col-4">
                  <small class="text-muted d-block">Compartment</small>
                  <span class="badge bg-success">{{.Compartimento}}</span>
                </div>
              </div>
              
              <!-- Actions -->
              {{if eq $.Role "admin"}}
              <div class="d-grid gap-2">
                <div class="btn-group" role="group">
                  <a href="/editar?id={{.ID}}" class="btn btn-outline-primary btn-sm">Edit</a>
                  <button class="btn btn-outline-danger btn-sm delete-btn" data-id="{{.ID}}">Delete</button>
                </div>
              </div>
              {{end}}
            </div>
          </div>
        </div>
        {{end}}
      {{else}}
        <div class="col-12">
          <div class="text-center py-5">
            <i class="text-muted fs-1">ðŸ“¦</i>
            <h5 class="text-muted mt-3">No items found</h5>
            <p class="text-muted">Try adjusting your search criteria.</p>
          </div>
        </div>
      {{end}}
    </div>

    {{if gt .Pagination.TotalPages 1}}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        <li class="page-item {{if eq .Pagination.CurrentPage 1}}disabled{{end}}">
          <a class="page-link" href="?page={{subtract .Pagination.CurrentPage 1}}{{if .Query}}&q={{.Query}}{{end}}">Previous</a>
        </li>
        {{range seq 1 .Pagination.TotalPages}}
        <li class="page-item {{if eq . $.Pagination.CurrentPage}}active{{end}}">
          <a class="page-link" href="?page={{.}}{{if $.Query}}&q={{$.Query}}{{end}}">{{.}}</a>
        </li>
        {{end}}
        <li class="page-item {{if eq .Pagination.CurrentPage .Pagination.TotalPages}}disabled{{end}}">
          <a class="page-link" href="?page={{add .Pagination.CurrentPage 1}}{{if .Query}}&q={{.Query}}{{end}}">Next</a>
        </li>
      </ul>
    </nav>
    {{end}}
  </div>

  {{if eq .Role "admin"}}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const preview = document.createElement('img');
      preview.className = 'photo-preview';
      document.body.appendChild(preview);

      document.querySelectorAll('.item-photo').forEach(img => {
        // Handle broken images
        img.addEventListener('error', function() {
          const placeholder = document.createElement('div');
          placeholder.className = 'no-photo-placeholder d-flex flex-column align-items-center justify-content-center rounded';
          placeholder.style.width = '150px';
          placeholder.style.height = '150px';
          placeholder.style.margin = '0 auto';
          placeholder.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          placeholder.style.color = 'white';
          placeholder.style.border = '2px solid #e9ecef';
          placeholder.innerHTML = `
            <svg width="48" height="48" fill="currentColor" class="bi bi-image mb-2" viewBox="0 0 16 16">
              <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
              <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/>
            </svg>
            <small style="color: rgba(255,255,255,0.7);">No Image</small>
          `;
          
          this.parentNode.replaceChild(placeholder, this);
        });

        img.addEventListener('mousemove', function(e) {
          // Get the full-size image URL directly from the data attribute
          const fullSizeUrl = this.src.replace('/thumbs/', '/');
          preview.src = fullSizeUrl;
          preview.style.display = 'block';
          
          // Set the preview size based on configuration
          preview.style.maxWidth = '{{.Config.PhotoPreviewSize}}px';
          preview.style.maxHeight = '{{.Config.PhotoPreviewSize}}px';
          
          // Calculate position to avoid going off screen
          const x = e.clientX + 20;
          const y = e.clientY + 20;
          const maxX = window.innerWidth - preview.width - 20;
          const maxY = window.innerHeight - preview.height - 20;
          
          preview.style.left = Math.min(x, maxX) + 'px';
          preview.style.top = Math.min(y, maxY) + 'px';
        });

        img.addEventListener('mouseleave', function() {
          preview.style.display = 'none';
        });
      });

      // Delete button handlers
      document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
          if (confirm('Are you sure you want to delete this item?')) {
            window.location.href = `/deletar?id=${this.getAttribute('data-id')}`;
          }
        });
      });
    });
  </script>
  {{end}}
</body>
</html>
