<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{.Config.Title}}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .item-photo {
      object-fit: cover;
      border-radius: 4px;
    }
    .photo-preview {
      display: none;
      margin-top: 10px;
    }
    .thumb-container {
      position: relative;
      display: inline-block;
    }
    .hover-preview {
      display: none;
      position: fixed;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .hover-preview img {
      max-width: 60vw;
      max-height: 60vh;
      object-fit: contain;
    }
    .thumb-container:hover .hover-preview {
      display: block;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>{{.Config.Title}}</h1>
      <a href="/estantes" class="btn btn-secondary">Manage Shelves</a>
    </div>

    <form action="/" method="get" class="card p-3 mb-4">
      <h5>Search Items</h5>
      <div class="row g-3">
        <div class="col-md-8">
          <input type="text" name="q" class="form-control" placeholder="Search by name or description..." value="{{.Query}}">
        </div>
        <div class="col-md-4">
          <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
      </div>
    </form>

    <form action="/novo" method="post" class="card p-3 mb-4" enctype="multipart/form-data">
      <h5>Add New Item</h5>
      <div class="row g-3">
        <div class="col-md-3">
          <input name="nome" class="form-control" placeholder="Name" required>
        </div>
        <div class="col-md-3">
          <input name="descricao" class="form-control" placeholder="Description" required>
        </div>
        <div class="col-md-2">
          <select name="estante" class="form-select" required>
            <option value="">Shelf</option>
            {{range .Estantes}}<option>{{.Nome}}</option>{{end}}
          </select>
        </div>
        <div class="col-md-2">
          <input name="prateleira" class="form-control" placeholder="Rack" required>
        </div>
        <div class="col-md-2">
          <input name="compartimento" class="form-control" placeholder="Compartment" required>
        </div>
        <div class="col-12">
          <div class="input-group">
            <input type="file" name="foto" class="form-control" accept="image/*" onchange="previewImage(this)">
          </div>
          <img id="preview" class="photo-preview">
        </div>
      </div>
      <div class="mt-3">
        <button class="btn btn-primary">Register</button>
      </div>
    </form>

    <table class="table table-striped">
      <thead class="table-dark">
        <tr>
          <th> </th>
          <th>Item</th>
          <th>Description</th>
          <th>Shelf</th>
          <th>Rack</th>
          <th>Compartment</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {{if .Itens}}
          {{range .Itens}}
          <tr>
            <td>
              {{if .Foto}}
                <div class="thumb-container">
                  <a href="/static/photos/{{.Foto}}" target="_blank">
                    <img src="/static/photos/thumbs/{{.Foto}}" class="item-photo" alt="{{.Nome}}" style="width: {{$.Config.PhotoThumbSize}}px; height: {{$.Config.PhotoThumbSize}}px;">
                  </a>
                  <div class="hover-preview">
                    <img src="/static/photos/{{.Foto}}" alt="{{.Nome}}">
                  </div>
                </div>
              {{else}}
                <div class="item-photo bg-secondary" style="width: {{$.Config.PhotoThumbSize}}px; height: {{$.Config.PhotoThumbSize}}px;"></div>
              {{end}}
            </td>
            <td>{{.Nome}}</td>
            <td>{{.Descricao}}</td>
            <td>{{.Estante}}</td>
            <td>{{.Prateleira}}</td>
            <td>{{.Compartimento}}</td>
            <td>
              <button class="btn btn-sm btn-primary me-2 edit-btn" 
                      data-id="{{.ID}}"
                      data-nome="{{.Nome}}"
                      data-descricao="{{.Descricao}}"
                      data-estante="{{.Estante}}"
                      data-prateleira="{{.Prateleira}}"
                      data-compartimento="{{.Compartimento}}"
                      data-foto="{{.Foto}}">Edit</button>
              <form action="/deletar?id={{.ID}}" method="post" style="display:inline-block">
                <button class="btn btn-sm btn-danger">Delete</button>
              </form>
            </td>
          </tr>
          {{end}}
        {{else}}
          <tr>
            <td colspan="6" class="text-center">
              {{if .Query}}
                No items found for "{{.Query}}"
              {{else}}
                No items registered
              {{end}}
            </td>
          </tr>
        {{end}}
      </tbody>
    </table>

    <!-- Pagination -->
    {{if gt .Pagination.TotalPages 1}}
    <nav aria-label="Page navigation" class="mt-4">
      <ul class="pagination justify-content-center">
        {{if gt .Pagination.CurrentPage 1}}
        <li class="page-item">
          <a class="page-link" href="?page={{subtract .Pagination.CurrentPage 1}}{{if .Query}}&q={{.Query}}{{end}}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        {{end}}

        {{range $i := seq 1 .Pagination.TotalPages}}
        <li class="page-item {{if eq $i $.Pagination.CurrentPage}}active{{end}}">
          <a class="page-link" href="?page={{$i}}{{if $.Query}}&q={{$.Query}}{{end}}">{{$i}}</a>
        </li>
        {{end}}

        {{if lt .Pagination.CurrentPage .Pagination.TotalPages}}
        <li class="page-item">
          <a class="page-link" href="?page={{add .Pagination.CurrentPage 1}}{{if .Query}}&q={{.Query}}{{end}}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
        {{end}}
      </ul>
    </nav>
    {{end}}

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editForm" action="/editar" method="post" enctype="multipart/form-data">
              <input type="hidden" name="id" id="editId">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Name</label>
                  <input name="nome" id="editNome" class="form-control" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Description</label>
                  <input name="descricao" id="editDescricao" class="form-control" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Shelf</label>
                  <select name="estante" id="editEstante" class="form-select" required>
                    <option value="">Select...</option>
                    {{range .Estantes}}<option>{{.Nome}}</option>{{end}}
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Rack</label>
                  <input name="prateleira" id="editPrateleira" class="form-control" required>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Compartment</label>
                  <input name="compartimento" id="editCompartimento" class="form-control" required>
                </div>
                <div class="col-12">
                  <label class="form-label">Photo</label>
                  <div class="input-group">
                    <input type="file" name="foto" class="form-control" accept="image/*" onchange="previewEditImage(this)">
                  </div>
                  <div class="mt-2">
                    <img id="currentPhoto" class="item-photo me-2" style="display: none;">
                    <img id="editPreview" class="photo-preview">
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="document.getElementById('editForm').submit()">Save</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function previewImage(input) {
      const preview = document.getElementById('preview');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        }
        reader.readAsDataURL(input.files[0]);
      } else {
        preview.style.display = 'none';
      }
    }

    function previewEditImage(input) {
      const preview = document.getElementById('editPreview');
      const currentPhoto = document.getElementById('currentPhoto');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
          currentPhoto.style.display = 'none';
        }
        reader.readAsDataURL(input.files[0]);
      } else {
        preview.style.display = 'none';
        if (currentPhoto.src) {
          currentPhoto.style.display = 'block';
        }
      }
    }

    function editItem(id, nome, descricao, estante, prateleira, compartimento, foto) {
      document.getElementById('editId').value = id;
      document.getElementById('editNome').value = nome;
      document.getElementById('editDescricao').value = descricao;
      document.getElementById('editEstante').value = estante;
      document.getElementById('editPrateleira').value = prateleira;
      document.getElementById('editCompartimento').value = compartimento;
      
      const currentPhoto = document.getElementById('currentPhoto');
      const editPreview = document.getElementById('editPreview');
      
      if (foto) {
        currentPhoto.src = '/static/photos/thumbs/' + foto;
        currentPhoto.style.display = 'block';
        editPreview.style.display = 'none';
      } else {
        currentPhoto.style.display = 'none';
      }
      
      new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    // Add hover preview positioning
    document.addEventListener('DOMContentLoaded', function() {
      const containers = document.querySelectorAll('.thumb-container');
      
      containers.forEach(container => {
        const preview = container.querySelector('.hover-preview');
        
        container.addEventListener('mousemove', (e) => {
          const rect = container.getBoundingClientRect();
          const x = e.clientX;
          const y = e.clientY;
          
          // Position the preview to the right of the cursor if there's space,
          // otherwise position it to the left
          const spaceRight = window.innerWidth - x;
          const previewWidth = preview.offsetWidth;
          
          if (spaceRight > previewWidth + 20) {
            preview.style.left = (x + 20) + 'px';
          } else {
            preview.style.left = (x - previewWidth - 20) + 'px';
          }
          
          // Position vertically, ensuring the preview stays within viewport
          const previewHeight = preview.offsetHeight;
          let topPosition = y - previewHeight / 2;
          
          // Adjust if preview would go outside viewport
          if (topPosition < 10) {
            topPosition = 10;
          } else if (topPosition + previewHeight > window.innerHeight - 10) {
            topPosition = window.innerHeight - previewHeight - 10;
          }
          
          preview.style.top = topPosition + 'px';
        });
      });
    });

    // Add event listeners for edit buttons
    document.addEventListener('DOMContentLoaded', function() {
      const editButtons = document.querySelectorAll('.edit-btn');
      editButtons.forEach(button => {
        button.addEventListener('click', function() {
          const id = this.dataset.id;
          const nome = this.dataset.nome;
          const descricao = this.dataset.descricao;
          const estante = this.dataset.estante;
          const prateleira = this.dataset.prateleira;
          const compartimento = this.dataset.compartimento;
          const foto = this.dataset.foto;
          
          editItem(id, nome, descricao, estante, prateleira, compartimento, foto);
        });
      });
    });
  </script>
</body>
</html>
